<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="utf-8">
  <link rel="shortcut icon" type="image/x-icon" href="favicon.png">
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
  <title>Sketch Labs</title>
  <script src="libs/p5.min.js"></script>
  <script src="libs/victor.min.js"></script>
  <script src="libs/seedrandom.min.js"></script>
  <script src="libs/ccapture.all.min.js"></script>
  <script src="libs/gif.worker.js"></script>

  <script type="text/javascript"> 

    // Constants
    var cSketches = [
      { id: "fbc39eb8", date: "April 11, 2020" },
      { id: "31569c5b", date: "April 9, 2020" }
    ];

    var cRecordingWidth = 540;
    var cRecordingHeight = 540;
    var cRecordingFps = 30;
    var cRecordingNumFrames = cRecordingFps*4;

  
    // Globals
    var gRenderWidth;
    var gRenderHeight;    
    var gIsRecording = false;
    var gNumFramesRecorded = 0;
    var gRenderTime = 0;
    var gRenderDeltaTime = 0; // in seconds!

    // Locals
    var currentSketchIndex = -1;

    var capturer;
    var preRecordingRenderTime;


    function getUrlVars() 
    {
      var vars = {};
      var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
          vars[key] = value;
      });
      return vars;
    }

    function getUrlParam(parameter, defaultvalue)
    {
      var urlparameter = defaultvalue;
      if(window.location.href.indexOf(parameter) > -1)
      {
        urlparameter = getUrlVars()[parameter];
      }
      return urlparameter;
    }

    function onPageLoad()
    {
      if (currentSketchIndex >= 0)
      {
        var sketch = cSketches[currentSketchIndex];

        // Update title bar
        document.getElementById("sketchTitle").innerText = sketch.id;
        document.getElementById("sketchDate").innerText = sketch.date;    

        // Prev
        var prevA = document.getElementById("prevA");
        prevA.href = (currentSketchIndex >= 1) ? ("http://localhost:8080/?sketch=" + cSketches[currentSketchIndex-1].id) : "#";
        prevA.setAttribute('class', (currentSketchIndex >= 1) ? "sketchNextPrev" : "sketchNextPrevDisabled");
          

        // Next
        var nextA = document.getElementById("nextA");
        nextA.href = (currentSketchIndex < cSketches.length-1) ? ("http://localhost:8080/?sketch=" + cSketches[currentSketchIndex+1].id) : "#";
        nextA.setAttribute('class', (currentSketchIndex < cSketches.length-1) ? "sketchNextPrev" : "sketchNextPrevDisabled");       
      }
      // currentSketchIndex == -1?
      else 
      {
        for (var i=0; i<cSketches.length; ++i)
        {
          var sketch = cSketches[i];

          var a=document.createElement('a');
          a.setAttribute("href", "?sketch=" + sketch.id);
          a.innerHTML = sketch.id + "<br/>";
          document.body.appendChild(a);  
        }

        // Hide the navigation bar
        document.getElementById("navigationBar").style.display = "none";
      }
    }

    function startRecord()
    {
      if (gIsRecording)
        return;

      console.log("Starting recording.");

      if (!capturer)
      {
        capturer = new CCapture( {
          framerate: cRecordingFps,          
          format: 'gif',
          workersPath: './libs/',
          verbose: false,
          name: cSketches[currentSketchIndex].id
          });
      }

      preRecordingRenderTime = gRenderTime;
      gNumFramesRecorded = 0;
      gRenderTime = 0;
      gIsRecording = true;
    }


    function preDraw()
    {
      gRenderDeltaTime = !gIsRecording ? (deltaTime/1000.0) : (1.0/cRecordingFps);

      gRenderWidth = !gIsRecording ? window.innerWidth : cRecordingWidth;
      gRenderHeight = !gIsRecording ? window.innerHeight : cRecordingHeight;

      // Resize canvas if needed.
    	if (canvas.width/pixelDensity() != gRenderWidth || canvas.height/pixelDensity() != gRenderHeight)
	 	    resizeCanvas(gRenderWidth, gRenderHeight, false);
    }

    function postDraw()
    {
      gRenderTime += gRenderDeltaTime;

      if (!gIsRecording)
        return;

      console.log("Recording frame.");

      if (gNumFramesRecorded == 0)
        capturer.start();

      capturer.capture(canvas);
      gNumFramesRecorded++;

      // Done?
      if (gNumFramesRecorded >= cRecordingNumFrames)
      {
        gIsRecording = false;
        capturer.stop();
        capturer.save();
        console.log("Saving recording.");
        gRenderTime = preRecordingRenderTime;
      }      
    }


    var sketchStr = getUrlParam("sketch", null);

    if (sketchStr != null)
    {
      for (var i=0; i<cSketches.length; ++i)
      {
        if (cSketches[i].id == sketchStr)
        {
          currentSketchIndex = i;
          break;
        }
      }
    }

    if (currentSketchIndex >= 0)
    {
      var sketch = cSketches[currentSketchIndex];

      // Open sketch's js file
      var fileref=document.createElement('script');
      fileref.setAttribute("type","text/javascript");
      fileref.setAttribute("src", "sketches/" + sketch.id + ".js");
      document.head.appendChild(fileref);  
    }
  </script>   

  <style>
    body 
    {
      touch-action: none;  
      margin:0px;
      display:block;
      padding: 0px;
    }
    div
    {
      left:0px;
      top:0px;
      width: 100%;
      height: auto;
      background-color: white;
      position: absolute;
      float: top;
      z-index:1000;
      font-family: 'Raleway', sans-serif;
      user-select: none;
      display: flex;      
      align-items: center;
    }
    .sketchTitle
    {      
      font-size: 30px;
      font-weight: 600;
      float: left;
      margin: 8px;
    }
    .sketchDate
    {      
      font-size: 16px;
      font-weight: 500;
      float: left;
      margin-right: 8px;
    }   
    .sketchAuthor
    {      
      font-size: 13px;
      font-weight: 400;
      float: left;
      margin-right: 8px;
    }     
    .sketchNextPrev, .sketchNextPrevDisabled, .sketchRecord
    {      
      font-size: 13px;
      font-weight: 400;
      float: right;
      padding:2px;
    }  
    .sketchNextPrevDisabled
    {
      cursor: not-allowed;
      opacity: 0.5;
      text-decoration: none;
    }  
  </style>
</head>

<body onload="onPageLoad();">
  <div id="navigationBar">
    <span id="sketchTitle" class="sketchTitle">TITLE</span>
    <span id="sketchDate" class="sketchDate">DATE</span>
    <span id="sketchAuthor" class="sketchAuthor">by <a href="http://www.thijskruithof.nl" target="_blank">Thijs Kruithof</a>, source on <a href="https://github.com/thijskruithof/sketches/tree/master/docs/sketches" target="_blank">GitHub</a>.</span>
    <span id="sketchHome" class="sketchNextPrev"><a id="homeA" href="?">Home</a></span>
    <span id="sketchPrev" class="sketchNextPrev"><a id="prevA" href="#">Prev</a></span>
    <span id="sketchNext" class="sketchNextPrev"><a id="nextA" href="#">Next</a></span>
    <span id="sketchRecord" class="sketchRecord"><a id="recordA" href="#" onclick="startRecord();">Capture</a></span>
  </div>
</body>

</html>